<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte d'Identité Otaku</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        body {
            font-family: georgia;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(500deg, black, blue);
            margin: 0;
        }

        .card-container {
            width: 330px;
            height: 240px;
            background: linear-gradient(400deg,skyblue,#F3E5AB);
            border-radius: 10px;
            box-shadow: 4px 4px 15px rgba(0, 0, 0, 0.4);
            padding: 15px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            border: 2px solid #d1d1d1;
        }

        .header {
            text-transform: uppercase;
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-align: center;
            margin-bottom: 10px;
            padding: 8px 0;
            background: linear-gradient(to right, #007BFF, #66B2FF);
            border-radius: 8px;
        }

        .profile-section {
            display: flex;
            align-items: center;
            margin-top: 10px;
            position: relative;
        }

        .profile-picture {
            width: 100px;
            height: 120px;
            border-radius: 5px;
            border: 2px solid #ccc;
            background: #ddd;
            overflow: hidden;
        }

        .profile-picture img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .info-section {
            margin-left: 20px;
            font-size: 14px;
            color: #000;
            flex-grow: 1;
        }

        .info-section p {
            margin: 4px 0;
            font-weight: bold;
        }

        .qr-code {
            width: 70px;
            height: 50px;
            position: absolute;
            bottom: 45px;
            right: 7px;  
            box-shadow: 1 1 1px rgba(black,black,1,);
        }

        .chip {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 50px;
            height: 35px;
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAANCAYAAACZ6+5GAAAAQ0lEQVQY02NkIBIwEqmOgQKGjAAB/kIuJGa3MCSkA1AKxGpCmXZwQAH3HC0AGwpMCCKkYqk2SJjAJG6bCgBV4xgA/2B2ZgAAAABJRU5ErkJggg==') no-repeat center;
            background-size: cover;
        }

        footer {
            width: 100%;
            text-align: center;
            position: absolute;
            bottom: 0;
            left: 0;
            padding: 8px 0;
            background: linear-gradient(to right, #007BFF, #0056b3);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .btn-download {
            margin-top: 20px;
            padding: 10px 20px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-download:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>

    <div id="carteOtaku" class="card-container">
        <div class="header">Carte d'Identité Otaku</div>
        <div class="chip"></div>
        <div class="profile-section">
            <div class="profile-picture">
                <img id="photoAffiche" src="" alt="Photo">
            </div>
            <div class="info-section">
                <p><strong>Nom :</strong> <span id="pseudoAffiche">---</span></p>
                <p><strong>Prénom :</strong> <span id="nomAffiche">---</span></p>
                <p><strong>Personnage préféré :</strong> <span id="nationaliteAffiche">---</span></p>
                <p><strong>Anime préféré :</strong> <span id="statutAffiche">---</span></p>
                <p><strong>Type de manga :</strong> <span id="genreAffiche">---</span></p>
                <p><strong>Rang :</strong> <span id="citationAffiche">---</span></p>
            </div>
        </div>
        <img id="qrCode" class="qr-code" src="" alt="QR Code">
        <footer>Carte officielle Otaku</footer>
    </div>

    <button class="btn-download" onclick="downloadCarte()">Télécharger la carte</button>

    <script>
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                pseudo: params.get("pseudo"),
                nom: params.get("nom"),
                nationalite: params.get("nationalite"),
                statut: params.get("statut"),
                genre: params.get("genre"),
                citation: params.get("citation")
            };
        }

        const data = getQueryParams();
        document.getElementById("pseudoAffiche").textContent = data.pseudo || "---";
        document.getElementById("nomAffiche").textContent = data.nom || "---";
        document.getElementById("nationaliteAffiche").textContent = data.nationalite || "---";
        document.getElementById("statutAffiche").textContent = data.statut || "---";
        document.getElementById("genreAffiche").textContent = data.genre || "---";
        document.getElementById("citationAffiche").textContent = data.citation || "---";

        // On recupere la photo de localStorage
        const photoData = localStorage.getItem("otakuPhoto");
        if (photoData) {
            document.getElementById("photoAffiche").src = photoData;
        }

        // C'est mieux d'utiliser du json pour générer un QR Code dynamique basé sur les données de la carte
        const cardData = JSON.stringify(data);
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(cardData)}`;
        document.getElementById("qrCode").src = qrCodeUrl;

        // On supprimer la photo de localStorage après utilisation pour ne pas surcharger le navigateur mais tu peux supprimer cette partie
        localStorage.removeItem("otakuPhoto");

        function downloadCarte() {
            const card = document.getElementById("carteOtaku");
            // Attendre que toutes les images soient chargées
            const images = card.getElementsByTagName("img");
            const imagePromises = Array.from(images).map(img => {
                if (img.complete) return Promise.resolve();
                return new Promise(resolve => {
                    img.onload = resolve;
                    img.onerror = resolve; // Continuer même en cas d'erreur
                });
            });

            Promise.all(imagePromises).then(() => {
                html2canvas(card, {
                    scale: 3,
                    useCORS: true,
                    allowTaint: false
                }).then(canvas => {
                    const link = document.createElement("a");
                    link.href = canvas.toDataURL("image/png");
                    link.download = "Carte_Otaku.png";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }).catch(error => {
                    console.error("Erreur de capture :", error);
                });
            });
        }
    </script>

</body>
</html>
